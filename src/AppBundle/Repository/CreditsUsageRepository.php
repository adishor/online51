<?php

namespace AppBundle\Repository;

use Doctrine\ORM\EntityRepository;
use AppBundle\Entity\CreditsUsage;

/**
 * OrderRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CreditsUsageRepository extends EntityRepository
{

    public function findAllValidUserDocuments($userId, $domainId = null)
    {
        $queryBuilder = $this->getEntityManager()
          ->createQueryBuilder()
          ->select('DISTINCT(d.id) as id, d.name, cu.createdAt as unlockDate, cu.credit, cu.expireDate as date, sd.name as subDomain, dom.name as domain')
          ->from('AppBundle:Document', 'd')
          ->join('Application\Sonata\MediaBundle\Entity\Media', 'm', 'WITH', 'd.media = m')
          ->join('AppBundle:CreditsUsage', 'cu', 'WITH', 'cu.document = d')
          ->join('AppBundle:SubDomain', 'sd', 'WITH', 'd.subdomain = sd')
          ->join('AppBundle:Domain', 'dom', 'WITH', 'sd.domain = dom')
          ->where('cu.user = :user')
          ->setParameter('user', $userId)
          ->andWhere('cu.expireDate > :now')
          ->setParameter('now', new \DateTime)
          ->andWhere('d.deleted = FALSE')
          ->andWhere('m.deleted = FALSE')
          ->andWhere('cu.deleted = FALSE')
          ->andWhere('sd.deleted = FALSE')
          ->andWhere('dom.deleted = FALSE');
        if (null !== $domainId) {
            $queryBuilder->andWhere('sd.domain = :domain')
              ->setParameter('domain', $domainId);
        }
        $queryBuilder->orderBy('dom.id')
          ->orderBy('sd.id')
          ->orderBy('d.id', 'DESC');

        $query = $queryBuilder->getQuery();

        return $query->getArrayResult();
    }

    public function findAllUserDocuments($userId)
    {
        $queryBuilder = $this->getEntityManager()
          ->createQueryBuilder()
          ->select('d.id, m.id as mediaId, d.name, cu.mentions, cu.createdAt as unlockDate, cu.credit, cu.expireDate')
          ->from('AppBundle:Document', 'd')
          ->join('Application\Sonata\MediaBundle\Entity\Media', 'm', 'WITH', 'd.media = m')
          ->join('AppBundle:CreditsUsage', 'cu', 'WITH', 'cu.document = d')
          ->where('cu.user = :user')
          ->setParameter('user', $userId)
          ->andWhere('cu.deleted = FALSE')
          ->orderBy('unlockDate', 'DESC');

        $query = $queryBuilder->getQuery();

        return $query->getArrayResult();
    }

    public function findAllUserExpiredCredit($userId)
    {
        $queryBuilder = $this->getEntityManager()
          ->createQueryBuilder()
          ->select('cu.mentions, cu.createdAt as unlockDate, cu.credit, cu.expireDate')
          ->from('AppBundle:CreditsUsage', 'cu')
          ->where('cu.user = :user')
          ->setParameter('user', $userId)
          ->andWhere('cu.deleted = FALSE')
          ->andWhere('cu.usageType = :expired')
          ->setParameter('expired', CreditsUsage::TYPE_EXPIRED)
          ->orderBy('unlockDate', 'DESC');

        $query = $queryBuilder->getQuery();

        return $query->getArrayResult();
    }

    public function findValidUserDocument($userId, $documentId)
    {
        $queryBuilder = $this->getEntityManager()
          ->createQueryBuilder()
          ->select('d.id')
          ->from('AppBundle:Document', 'd')
          ->join('Application\Sonata\MediaBundle\Entity\Media', 'm', 'WITH', 'd.media = m')
          ->join('AppBundle:CreditsUsage', 'cu', 'WITH', 'cu.document = d')
          ->where('cu.user = :user')
          ->setParameter('user', $userId)
          ->andWhere('cu.expireDate > :now')
          ->setParameter('now', new \DateTime)
          ->andWhere('d.id = :document')
          ->setParameter('document', $documentId)
          ->andWhere('d.deleted = FALSE')
          ->andWhere('m.deleted = FALSE')
          ->andWhere('cu.deleted = FALSE');

        $query = $queryBuilder->getQuery();

        return $query->getArrayResult();
    }

    public function findValidUserFormular($userId, $formularId, $formularConfig)
    {
        $formHash = md5(json_encode($userId) . json_encode($formularConfig));

        $queryBuilder = $this->getEntityManager()
          ->createQueryBuilder()
          ->select('cu.id')
          ->from('AppBundle:CreditsUsage', 'cu')
          ->join('cu.formular', 'f')
          ->where('cu.user = :user')
          ->setParameter('user', $userId)
          ->andWhere('cu.expireDate > :now')
          ->setParameter('now', new \DateTime)
          ->andWhere('cu.formHash = :formHash')
          ->setParameter('formHash', $formHash)
          ->andWhere('f.id = :formular')
          ->setParameter('formular', $formularId)
          ->andWhere('cu.deleted = FALSE')
          ->andWhere('f.deleted = FALSE')
        ;

        $query = $queryBuilder->getQuery();

        return $query->getArrayResult();
    }

    public function findTotalUsedCredits($userId)
    {
        $queryBuilder = $this->getEntityManager()
          ->createQueryBuilder()
          ->select('sum(cu.credit)')
          ->from('AppBundle:CreditsUsage', 'cu')
          ->where('cu.user = :user')
          ->andWhere('cu.usageType != :expired')
          ->andWhere('cu.deleted = FALSE')
          ->setParameter('expired', CreditsUsage::TYPE_EXPIRED)
          ->setParameter('user', $userId);

        $query = $queryBuilder->getQuery();
        $result = $query->getSingleScalarResult();

        return ($result) ? $result : 0;
    }

    public function findTotalExpiredCredits($userId)
    {
        $queryBuilder = $this->getEntityManager()
          ->createQueryBuilder()
          ->select('sum(cu.credit)')
          ->from('AppBundle:CreditsUsage', 'cu')
          ->where('cu.user = :user')
          ->andWhere('cu.deleted = FALSE')
          ->andWhere('cu.usageType = :expired')
          ->setParameter('expired', CreditsUsage::TYPE_EXPIRED)
          ->setParameter('user', $userId);

        $query = $queryBuilder->getQuery();
        $result = $query->getSingleScalarResult();

        return ($result) ? $result : 0;
    }

}