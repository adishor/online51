<?php

namespace AppBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * OrderRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CreditsUsageRepository extends EntityRepository
{

    public function findAllValidUserDocuments($user, $now, $domain)
    {
        $queryBuilder = $this->getEntityManager()
          ->createQueryBuilder()
          ->select('DISTINCT(d.id)')
          ->from('Application\Sonata\MediaBundle\Entity\Media', 'd')
          ->join('AppBundle:CreditsUsage', 'cu', 'WITH', 'cu.document = d')
          ->join('AppBundle:SubDomain', 'sd', 'WITH', 'd.subdomain = sd')
          ->where('cu.user = :user')
          ->setParameter('user', $user)
          ->andWhere('cu.documentExpireDate > :now')
          ->setParameter('now', $now)
          ->andWhere('sd.domain = :domain')
          ->setParameter('domain', $domain);

        $query = $queryBuilder->getQuery();

        return $query->getArrayResult();
    }

}